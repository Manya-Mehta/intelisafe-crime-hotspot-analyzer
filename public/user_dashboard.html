 <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Crime Dashboard</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
/* ==================== EXISTING CSS ==================== */
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:linear-gradient(135deg,#0f0f23 0%,#1a1a2e 50%,#16213e 100%); color:#fff; min-height:100vh; overflow-x:hidden; }
.container { max-width:1400px; margin:0 auto; padding:20px; }
.header { text-align:center; margin-bottom:40px; position:relative; overflow:hidden; }
.header::before { content:''; position:absolute; top:-50%; left:-50%; width:200%; height:200%; background:radial-gradient(circle, rgba(34,193,195,0.1) 0%, transparent 50%); animation:rotate 20s linear infinite; }
@keyframes rotate {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }
.header h1 { font-size:3rem; font-weight:700; background:linear-gradient(45deg,#22c1c3,#fdbb2d,#e73c7e); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:10px; position:relative; z-index:2; }
.header .subtitle { font-size:1.2rem; opacity:0.8; position:relative; z-index:2; }
.nav-tabs { display:flex; justify-content:center; margin-bottom:40px; background:rgba(255,255,255,0.05); border-radius:50px; padding:8px; backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.1); flex-wrap:wrap; }
.nav-tab { padding:15px 25px; border:none; background:transparent; color:#fff; cursor:pointer; border-radius:40px; font-size:1rem; font-weight:500; transition:all 0.3s ease; position:relative; overflow:hidden; margin:5px; }
.nav-tab::before { content:''; position:absolute; top:0; left:-100%; width:100%; height:100%; background:linear-gradient(45deg,#22c1c3,#fdbb2d); transition:left 0.3s ease; z-index:-1; }
.nav-tab.active::before { left:0; }
.nav-tab:hover { transform:translateY(-2px); box-shadow:0 10px 20px rgba(34,193,195,0.3); }
.nav-tab.active { color:#fff; box-shadow:0 10px 30px rgba(34,193,195,0.4); }
.tab-content { display:none; animation:fadeIn 0.5s ease; }
.tab-content.active { display:block; }
@keyframes fadeIn { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }
.card { background:rgba(255,255,255,0.05); border-radius:20px; padding:30px; margin-bottom:30px; backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.1); transition:all 0.3s ease; position:relative; overflow:hidden; }
.card::before { content:''; position:absolute; top:0; left:-100%; width:100%; height:2px; background:linear-gradient(90deg,#22c1c3,#fdbb2d,#e73c7e); transition:left 0.3s ease; }
.card:hover::before { left:0; }
.card:hover { transform:translateY(-5px); box-shadow:0 20px 40px rgba(34,193,195,0.2); }
.card h2 { font-size:1.8rem; margin-bottom:20px; color:#22c1c3; }
.map-container { height:400px; border-radius:15px; border:2px solid rgba(34,193,195,0.3); overflow:hidden; }
#map { width:100%; height:100%; border-radius:15px; }
.form-group { margin-bottom:20px; }
.form-group label { display:block; margin-bottom:8px; color:#22c1c3; font-weight:600; font-size:1rem; }
.form-input { width:100%; padding:15px; border:2px solid rgba(34,193,195,0.3); border-radius:12px; background:rgba(255,255,255,0.05); color:#fff; font-size:1rem; transition:all 0.3s ease; resize:vertical; }
.form-input:focus { outline:none; border-color:#22c1c3; box-shadow:0 0 20px rgba(34,193,195,0.3); }
.form-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; }
.btn { padding:15px 30px; border:none; border-radius:25px; font-size:1rem; font-weight:600; cursor:pointer; transition:all 0.3s ease; position:relative; overflow:hidden; text-transform:uppercase; letter-spacing:1px; display:inline-flex; align-items:center; gap:10px; }
.btn-primary { background:linear-gradient(45deg,#22c1c3,#fdbb2d); color:white; }
.btn:hover { transform:translateY(-3px); box-shadow:0 15px 30px rgba(34,193,195,0.4); }
.report-card { background:rgba(255,255,255,0.05); border-radius:15px; padding:25px; margin-bottom:20px; border-left:4px solid #22c1c3; transition:all 0.3s ease; cursor:pointer; }
.report-card:hover { background:rgba(34,193,195,0.1); transform:translateX(10px); }
.report-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
.report-type { background:linear-gradient(45deg,#22c1c3,#fdbb2d); color:white; padding:5px 15px; border-radius:20px; font-size:0.8rem; font-weight:600; text-transform:uppercase; }
.report-date { color:#fdbb2d; font-size:0.9rem; }
.report-location { font-size:1.1rem; margin-bottom:10px; }
.report-description { opacity:0.8; line-height:1.5; }
.report-status { display:inline-block; padding:4px 12px; border-radius:15px; font-size:0.8rem; font-weight:600; margin-top:10px; text-transform:capitalize; }
.status-pending { background: rgba(253,187,45,0.2); color:#fdbb2d; border:1px solid #fdbb2d; }
.status-investigating { background: rgba(34,193,195,0.2); color:#22c1c3; border:1px solid #22c1c3; }
.status-resolved { background: rgba(46,213,115,0.2); color:#2ed573; border:1px solid #2ed573; }
.quick-stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom:30px; }
.stat-card { background: rgba(255,255,255,0.05); padding:25px; border-radius:15px; text-align:center; border:1px solid rgba(255,255,255,0.1); transition:all 0.3s ease; position:relative; overflow:hidden; }
.stat-number { font-size:2.5rem; font-weight:700; color:#22c1c3; margin-bottom:10px; }
.stat-label { font-size:1rem; opacity:0.8; text-transform:uppercase; letter-spacing:1px; }
.location-input { position:relative; }
.location-input .location-icon { position:absolute; right:15px; top:50%; transform:translateY(-50%); color:#22c1c3; cursor:pointer; font-size:1.2rem; }
@media(max-width:768px){.header h1{font-size:2rem;}.nav-tabs{flex-direction:column;}.nav-tab{margin:5px 0;}.card{padding:20px;}.form-row{grid-template-columns:1fr;}}

#crime-type option { color: black; background: white; }
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>InteliSafe</h1> <br>
        <h2>User Crime Dashboard</h2>
        <p class="subtitle">Report Incidents ‚Ä¢ View Hotspots ‚Ä¢ Track Your Reports</p>
    </div>

    <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('hotspots', event)">üó∫Ô∏è Hotspots</button>
        <button class="nav-tab" onclick="switchTab('report-crime', event)">üìù Report Crime</button>
        <button class="nav-tab" onclick="switchTab('my-reports', event)">üìã My Reports</button>
    </div>

    <!-- Hotspots Tab -->
    <div id="hotspots" class="tab-content active">
        <div class="quick-stats">
            <div class="stat-card"><div class="stat-number" id="total-hotspots">0</div><div class="stat-label">Active Hotspots</div></div>
            <div class="stat-card"><div class="stat-number" id="week-incidents">0</div><div class="stat-label">This Week</div></div>
            <div class="stat-card"><div class="stat-number" id="nearest-hotspot">--</div><div class="stat-label">Nearest Hotspot</div></div>
        </div>
        <div class="card">
            <h2>üó∫Ô∏è Crime Hotspot Map</h2>
            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- Report Crime Tab -->
    <div id="report-crime" class="tab-content">
        <div class="card">
            <h2>üìù Submit a Crime Report</h2>
            <form id="crime-report-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="crime-type">Crime Type</label>
                        <select id="crime-type" class="form-input" required>
                            <option value="">Select Crime Type</option>
                            <option value="theft">Theft</option>
                            <option value="assault">Assault</option>
                            <option value="burglary">Burglary</option>
                            <option value="vandalism">Vandalism</option>
                            <option value="drug-related">Drug Related</option>
                            <option value="domestic-violence">Domestic Violence</option>
                            <option value="fraud">Fraud</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="incident-date">Incident Date & Time</label>
                        <input type="datetime-local" id="incident-date" class="form-input" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group location-input">
                        <label for="latitude">Latitude</label>
                        <input type="number" id="latitude" class="form-input" step="any" required>
                    </div>
                    <div class="form-group location-input">
                        <label for="longitude">Longitude</label>
                        <input type="number" id="longitude" class="form-input" step="any" required>
                        <span class="location-icon" onclick="getCurrentLocation()" title="Get current location">üìç</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="location-description">Location Description</label>
                    <input type="text" id="location-description" class="form-input" required>
                </div>

                <div class="form-group">
                    <label for="description">Incident Description</label>
                    <textarea id="description" class="form-input" rows="5" required></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="witness-contact">Witness Contact (Optional)</label>
                        <input type="text" id="witness-contact" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="reporter-contact">Your Contact (Optional)</label>
                        <input type="text" id="reporter-contact" class="form-input">
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">Submit Report</button>
            </form>
        </div>
    </div>

    <!-- My Reports Tab -->
    <div id="my-reports" class="tab-content">
        <div class="quick-stats">
            <div class="stat-card"><div class="stat-number" id="total-reports">0</div><div class="stat-label">Total Reports</div></div>
            <div class="stat-card"><div class="stat-number" id="pending-reports">0</div><div class="stat-label">Pending</div></div>
            <div class="stat-card"><div class="stat-number" id="resolved-reports">0</div><div class="stat-label">Resolved</div></div>
        </div>
        <div class="card">
            <h2>üìã Crime Reports</h2>
            <div id="reports-list"><p>Loading reports...</p></div>
        </div>
    </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script>
// Tab Switching 
function switchTab(tabName,event){
    document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');
    if(tabName==='my-reports'){ fetchReports(); }
}

// Map Init
let map, heatLayer, tempMarker;
function initMap(){
    map = L.map('map').setView([23.0225,72.5714], 12); // Default: Ahmedabad
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    loadHotspots();
}

// Load Hotspots from API
async function loadHotspots(){
    try{
        const res = await fetch('/api/reports');
        const reports = await res.json();

        // Remove existing heatLayer
        if(heatLayer) map.removeLayer(heatLayer);

        // Prepare points
        const heatPoints = reports.map(r=>[r.latitude, r.longitude, r.severity || 1]);

        // Heatmap
        heatLayer = L.heatLayer(heatPoints, {radius: 25, blur: 15, maxZoom: 17}).addTo(map);

        // Add markers
        reports.forEach(r=>{
            const marker = L.marker([r.latitude, r.longitude]).addTo(map);
            marker.bindPopup(`<b>${r.crimeType}</b><br>${r.locationDesc || ""}<br>${new Date(r.incidentDate || r.date).toLocaleString()}<br>Severity: ${r.severity || 1}`);
        });

        // Update stats
        document.getElementById('total-hotspots').textContent = reports.length;
        const weekIncidents = reports.filter(r=> (new Date() - new Date(r.incidentDate || r.date)) <= 7*24*60*60*1000).length;
        document.getElementById('week-incidents').textContent = weekIncidents;

    }catch(err){ console.error("Map fetch error:", err); }
}

// Get Current Location
function getCurrentLocation(){
    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
            document.getElementById('latitude').value=pos.coords.latitude.toFixed(6);
            document.getElementById('longitude').value=pos.coords.longitude.toFixed(6);
            map.setView([pos.coords.latitude, pos.coords.longitude], 14);
            if(tempMarker) map.removeLayer(tempMarker);
            tempMarker = L.marker([pos.coords.latitude,pos.coords.longitude]).addTo(map).bindPopup("You are here").openPopup();
        });
    }
}

// Fetch Reports 
async function fetchReports(){
    const list=document.getElementById('reports-list');
    list.innerHTML='<p>Loading...</p>';
    try{
        const res = await fetch('/api/reports');
        const data = await res.json();
        list.innerHTML='';
        data.reverse().forEach(r=>{
            const div=document.createElement('div');
            div.className='report-card';
            div.innerHTML=`<div class="report-header"><div class="report-type">${r.crimeType}</div>
            <div class="report-date">${new Date(r.incidentDate || r.date).toLocaleDateString()}</div></div>
            <div class="report-location">üìç ${r.locationDesc || ""}</div>
            <div class="report-description">${r.description}</div>
            <div class="report-status status-${r.status}">${r.status}</div>`;
            list.appendChild(div);
        });
        updateStats();
    }catch{ list.innerHTML='<p style="color:red">Error loading reports</p>'; }
}

// Update Stats
function updateStats(){
    const total=document.querySelectorAll('.report-card').length;
    const pending=document.querySelectorAll('.status-pending').length;
    const resolved=document.querySelectorAll('.status-resolved').length;
    document.getElementById('total-reports').textContent=total;
    document.getElementById('pending-reports').textContent=pending;
    document.getElementById('resolved-reports').textContent=resolved;
}

// Auto-fill Date & Init Map
document.addEventListener('DOMContentLoaded', ()=>{
    initMap();
    const now=new Date();
    now.setMinutes(now.getMinutes()-now.getTimezoneOffset());
    document.getElementById('incident-date').value=now.toISOString().slice(0,16);
});

// Fetch Coordinates from Address
async function fetchCoordinatesFromAddress() {
    const address = document.getElementById('location-description').value.trim();
    if (!address) return;
    try {
        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
        const data = await res.json();
        if(data.length>0){
            const { lat, lon } = data[0];
            document.getElementById('latitude').value=parseFloat(lat).toFixed(6);
            document.getElementById('longitude').value=parseFloat(lon).toFixed(6);
            map.setView([lat, lon], 14);
            if(tempMarker) map.removeLayer(tempMarker);
            tempMarker=L.marker([lat, lon]).addTo(map).bindPopup("Reported Location").openPopup();
        }
    }catch(err){ console.error("Geocoding error:", err); }
}
document.getElementById('location-description').addEventListener('blur', fetchCoordinatesFromAddress);

// Handle Report Submission
document.getElementById('crime-report-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const crimeType = document.getElementById('crime-type').value;
    const incidentDate = document.getElementById('incident-date').value;
    const latitude = parseFloat(document.getElementById('latitude').value);
    const longitude = parseFloat(document.getElementById('longitude').value);
    const locationDesc = document.getElementById('location-description').value.trim();
    const description = document.getElementById('description').value.trim();
    const witnessContact = document.getElementById('witness-contact').value.trim();
    const reporterContact = document.getElementById('reporter-contact').value.trim();

    if (!crimeType || !incidentDate || isNaN(latitude) || isNaN(longitude) || !locationDesc || !description) {
        alert("Please fill all required fields!");
        return;
    }

    try{
        const res = await fetch('/api/reports', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ crimeType, incidentDate, latitude, longitude, locationDesc, description, witnessContact, reporterContact })
        });
        const data = await res.json();
        if(data.success){
            alert("Report submitted successfully!");
            document.getElementById('crime-report-form').reset();
            const now=new Date();
            now.setMinutes(now.getMinutes()-now.getTimezoneOffset());
            document.getElementById('incident-date').value=now.toISOString().slice(0,16);

            if(tempMarker) map.removeLayer(tempMarker);
            tempMarker=L.marker([latitude, longitude]).addTo(map).bindPopup("Reported Location").openPopup();
            loadHotspots();
            if(document.getElementById('my-reports').classList.contains('active')){
                fetchReports();
            }
        } else {
            alert("Error submitting report: "+data.message);
        }
    }catch(err){ console.error(err); alert("Failed to submit report."); }
});
</script>


<footer style="text-align:center; margin-top:2rem; opacity:0.6;">
    <span id="version">v1.0.0</span>
</footer>
<script src="js/secret.js"></script>

</body>
</html>
